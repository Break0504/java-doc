## 1.1 分布式事务

### 1.1.1 什么是本地事务
    对同一个数据源，进行一组相关的sql操作(至少两个)，要么全部成功，要么全部失败(原子性)
    
### 1.1.2 本地事务的四个特性ACID
    原子性(Atomicity)：同生共死（一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成）
    一致性(Consistency)：相互匹配(a+b=10，a-2和b+2)
    隔离性(Isolation)：并行不扰(理论上两个并行的事务，相互之间互不干扰)
    持久性(Durability)：落子无悔(数据提交后，对数据的修改就是永久的，不可逆)

### 1.1.3 事务的隔离级别
    
    读未提交：
    读已提交：
    可重复读：
    串行化：
    
    
    全局事务管理器，管理多个数据源        
    
### 分布式事务
    全局事务管理器，管理多个数据源
    
#### 三种分布式服务架构
    1、单服务多库
        解决方案：(全局事务管理器TM)
    2、分库分表
        解决方案：中间件+数据库同步技术
        分库分表中间件：mycat/shardingdb
    3、多服务多数据源分布式事务
        解决方案：全局TM(数据库)和服务协调者(服务),共同协调\数据库资源\服务
        
#### 解决方案
    1、刚性事务:ACID(本地事务)
    2、柔性事务:(CAP\BASE)(分布式事务管理)
    
                时间      一致性要求       应用类型        场景
    刚性事务：   立刻      强一致性        局域网\企业应用    订单\日志
    柔性事务：   有时间弹性   最终一致性    互联网应用       付款、订单、收货
               
#### CAP
    P必须要保证，CP、AP
    
    一致性：    写操作之后的读操作，必须返回该值
    可用性：    非故障的节点在合理的时间内返回合理的响应
    分区容错性： 集群可用性
    
    为什么不保证 CA
    如果我们选择CA，而放弃P,那么当发生分区现象时，为了保证一致性，这个时候就必须拒绝请求，但是A又不允许，所以分布式
    系统理论上不可能选择CA架构，只能选择CP或AP
    
    
    CP应用：zookeeper
    AP:放弃强一致性，BASE理论的基础（最终一致性）
    AP例子：下单，购买了一件商品，不要求马上对库存进行扣减,但是只要最终库存扣减即可
#### BASE理论
    核心思想：分布式事务，只需达到最终一致性即可
    1、基本可用
    2、软状态：待付款、
    3、最终一致性
#### 柔性事务解决方案

##### 典型的柔性事务解决方案
    1、TCC（两阶段型、补偿性） 案例：（订婚-领证） 订婚(第一阶段)————结婚领证（成功提交事务\失败 双方回滚事务） 补偿（回滚）
    2、可靠消息最终一致性(异步确保型)消息队列来保证事务的一致性
        非事务型消息中间件(activimq、rabbitmq、kafka)
        事务性消息rocketmq(阿里的消息队列)
        案例：在线下棋 如果一方网络断点，通过消息队列，回滚双方的欢乐豆
    3、最大努力通知(非可靠消息、定期校对)
        案例：包裹消息通知   定时校对没有收到通知的包裹、定时补发通知；如果手机号是空号，就放弃通知，线下处理
        
    总结：
    1、BASE理论是CAP理论的延伸
        一致性\可用性\分区容错性
        只有CP和AP成立
    2、柔性事务（刚性事务对应）
        a、ACID刚性事务
        b、BASE\CAP柔性事务
    3、柔性事务的解决方案
        a、TCC（两阶段型、补偿性）
        b、消息保障型
        c、最大努力通知
                
### DTP和XA  二阶段提交协议(2PC tcc)

#### DTP模型
    1、模型元素（5个）
        应用程序（Application Program, 简称AP）:
        资源管理器（Resource Manager, 简称RM）: 如数据库、文件系统等，并提供访问资源方式
        事务管理器(Transaction Manager, 简称TM):负责分配事务唯一标识，监控事务的执行进度，并负责事务的提交和回滚
        通信资源管理器(Communication Resource Manager, 简称CRM):控制一个TM域(TM domain)内或者跨TM域的分布式应用之间的通信
        通信协议(Communication Protocol,简称CP)
        
    2、XA规范与二阶段协议的关系
        协议与接口(XA)
        
        --二阶段提交协议并非在XA规范中提出来的。但XA规范定义了两阶段提交协议中需要使用到的接口==。
        
    DTP :分布式事务处理的模型
    XA: 数据库和tm之间的接口
    
    二阶段
        优点：实现起来相对来说简单
        缺点：性能不高
        应用场景：对性能要求不高，并且要求数据强一致性时，可选择二阶段协议的方案
        
#### JTA与XA及atomikos的关系
    概念：(JTA:java Transaction API) xa的java实现版
    某种程度上，可以认为JTA规范是XA规范的java版，在JTA中，事务管理器抽象为javax.transaction.TransactionManager接口
    并通过底层事务服务(JTS)实现。
    
    JTA仅仅定义了接口
    实现：
        1、J2EE容器所提供的JTA实现(JBoss)
        2、独立的JTA实现：如JOTM,Atomikos,用于Tomcat,Jetty以及普通的java应用
        3、Atomikos JTA的实现，用于Tomcat等容器
        
        
            
        
         
        
        
        
              
       
    









































    

    
    
    
             